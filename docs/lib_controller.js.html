<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Source: lib/controller.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-modules"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-granax.html">granax</a></div><div class="sidebar-section-children"><a href="module-granax_commands.html">granax/commands</a></div><div class="sidebar-section-children"><a href="module-granax_replies.html">granax/replies</a></div><div class="sidebar-section-children"><a href="module-granax_torrc.html">granax/torrc</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="TorController.html">TorController</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-events"><div>Events</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="TorController.html#event:close">close</a></div><div class="sidebar-section-children"><a href="TorController.html#event:error">error</a></div><div class="sidebar-section-children"><a href="TorController.html#event:ready">ready</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">lib_controller.js</h1></header><article><pre class="prettyprint source lang-js"><code>'use strict';

const crypto = require('crypto');
const async = require('async');
const { Transform: TransformStream } = require('stream');
const merge = require('merge');
const { readFileSync } = require('fs');
const { EventEmitter } = require('events');
const commands = require('./commands');
const replies = require('./replies');


/**
 * Represents a Tor controller for issuing commands
 */
class TorController extends EventEmitter {

  static get CLIENT_HASH() {
    return 'Tor safe cookie authentication controller-to-server hash';
  }

  /**
   * Creates the challenge response from a SAFECOOKIE challenge
   * @param {string} cookie - The secret cookie string
   * @param {string} clientNonce - Client nonce sent with auth challenge
   * @param {string} serverNonce - Server nonce reply from auth challenge
   * @returns {string}
   */
  static createChallengeResponse(cookie, clientNonce, serverNonce) {
    return crypto.createHmac('sha256', TorController.CLIENT_HASH)
      .update(Buffer.concat([
        Buffer.from(cookie, 'hex'),
        Buffer.from(clientNonce, 'hex'),
        Buffer.from(serverNonce, 'hex')
      ]))
      .digest('hex');
  }

  /**
   * Creates a message splitter from incoming socket data
   * @static
   */
  static createReplySplitter() {
    return new TransformStream({
      objectMode: true,
      transform: function(data, enc, next) {
        let reply = [];
        let lines = data.toString().split('\r\n');

        for (let line of lines) {
          reply.push(line);

          if (line[3] === ' ') {
            this.push(reply);
            reply = [];
          }
        }

        next(null);
      }
    });
  }

  /**
   * Fired when the underlying socket encounters an error
   * @event TorController#error
   * @type {error}
   */

  /**
   * Fires when the controller is authenticated and ready to send commands
   * @event TorController#ready
   */

  /**
   * Fires when the underlying socket closes
   * @event TorController#close
   */

  static get DEFAULTS() {
    return {
      authOnConnect: true
    };
  }

  /**
   * @constructor
   * @param {Socket} socket - net.Socket connected to Tor's control port
   * @param {object} [options]
   * @param {boolean} [options.authOnConnect=true] - Automatically authenticate
   */
  constructor(socket, options) {
    super();

    this._opts = merge(TorController.DEFAULTS, options);
    this._stack = [];

    this.socket = socket
      .on('connect', () => this._handleConnect())
      .on('error', (err) => this._handleError(err))
      .on('close', () => this._handleClose());

    this.socket.pipe(TorController.createReplySplitter())
      .on('data', (data) => this._handleReply(data));
  }

  /**
   * Handles authentication routine on socket connect
   * @private
   * @param {function} callback
   */
  _authOnConnect(callback) {
    const self = this;
    const clientNonce = crypto.randomBytes(32).toString('hex');

    function maybeGetChallenge(cookie, authTypes, next) {
      if (authTypes.includes('SAFECOOKIE')) {
        self.getAuthChallenge(clientNonce, (err, result) => {
          next(err, result, cookie)
        });
      } else {
        next(null, {}, cookie);
      }
    }

    function sendAuthCommand({ hash, nonce }, cookie, next) {
      if (!(hash &amp;&amp; nonce)) {
        return self.authenticate(cookie, next);
      }

      self.authenticate(TorController.createChallengeResponse(
        cookie,
        clientNonce,
        nonce,
        hash
      ), next);
    }

    async.waterfall([
      (next) => this._getAuthCookie(next),
      (cookie, authTypes, next) => maybeGetChallenge(cookie, authTypes, next),
      (challenge, cookie, next) => sendAuthCommand(challenge, cookie, next)
    ], callback);
  }

  /**
   * Handles authentication upon socket connection
   * @private
   */
  _handleConnect() {
    if (this._opts.authOnConnect) {
      this._authOnConnect((err) => this.emit(err ? 'error': 'ready', err));
    } else {
      this.emit('ready');
    }
  }

  /**
   * Handles errors on the underlying socket and bubbles them
   * @private
   * @param {object} error
   */
  _handleError(err) {
    this.emit('error', err);
  }

  /**
   * Handles message processing and parsing from the socket
   * @private
   * @param {buffer} data
   */
  _handleReply(data) {
    let code = parseInt(data[0].substr(0, 3));
    let lines = data
      .filter((line) => !!line)
      .map((line) => line.substr(4).trim());

    switch (code.toString()[0]) {
      case '2':
        let reply = this._stack.pop();

        if (!reply) {
          return;
        }

        let { method, callback } = reply;
        let parsed = replies[method]
          ? replies[method](lines)
          : lines;
        callback(null, parsed);
        break;
      case '4':
      case '5':
        this._stack.pop().callback(new Error(lines[0]));
        break;
      case '6':
      default:
        let event = lines[0].split(' ')[0];
        lines[0] = lines[0].replace(`${event} `, '');
        this.emit(event, lines);
    }
  }

  /**
   * Handles socket close event and bubbles it
   * @private
   */
  _handleClose() {
    this.emit('close');
  }

  /**
   * Send an arbitrary command and pass response to callback
   * @private
   * @param {string} command
   * @param {function} callback
   */
  _send(command, callback) {
    const self = this;

    callback = callback || function(err) {
      /* istanbul ignore else */
      if (err) {
        self.emit('error', err);
      }
    };

    this._stack.unshift({ method: command.split(' ')[0], callback });
    this.socket.write(`${command}\r\n`);
  }

  /**
   * Load the authentication cookie
   * @private
   * @param {TorController~_getAuthCookieCallback} callback
   */
  _getAuthCookie(callback) {
    this.getProtocolInfo((err, info) => {
      if (err) {
        return callback(err);
      }

      try {
        callback(
          null,
          info.auth.cookieFile
            ? readFileSync(info.auth.cookieFile).toString('hex')
            : '',
          info.auth.methods
        );
      } catch (err) {
        callback(err);
      }
    });
  }
  /**
   * @private
   * @callback TorController~_getAuthCookieCallback
   * @param {object|null} error
   * @param {string} cookie
   * @param {string[]} authTypes
   */

  /**
   * Authenticates with the control port given the supplied param
   * @param {string} token
   * @param {TorController~authenticateCallback} callback
   */
  authenticate(token, callback) {
    this._send(commands.AUTHENTICATE(token), callback);
  }

  /**
   * Requests an authentication challenge from tor
   * @param {string} nonce - Client nonce for authenticating
   * @param {TorController~getAuthChallengeCallback} callback
   */
  getAuthChallenge(nonce, callback) {
    this._send(commands.AUTHCHALLENGE(nonce), callback);
  }
  /**
   * @callback TorController~getAuthChallengeCallback
   * @param {object|null} error
   * @param {AuthChallengeResult} result
   */

  /**
   * Ask tor for general information
   * @param {TorController~getProtocolInfoCallback} callback
   */
  getProtocolInfo(callback) {
    this._send(commands.PROTOCOLINFO(), callback);
  }
  /**
   * @callback TorController~getProtocolInfoCallback
   * @param {object|null} error
   * @param {ProtocolInfoResult} result
   */

  /**
   * Establishes a hidden service on the given target
   * @param {array} ports - Array containing optional virtualPort (defaults to 80) and target ip:port string
   * @param {object} [options] - {@link module:commands#ADD_ONION}
   * @param {TorController~createHiddenServiceCallback} callback
   */
  createHiddenService(ports, options, callback) {
    /* istanbul ignore if */
    if (typeof options === 'function') {
      callback = options;
      options = {};
    }

    this._send(commands.ADD_ONION(ports, options), callback);
  }
  /**
   * @callback TorController~createHiddenServiceCallback
   * @param {object|null} error
   * @param {AddOnionResult} result
   */

  /**
   * Takes down a running hidden service owned by this controller
   * @param {string} serviceId - Tor hidden service ID
   * @param {TorController~destroyHiddenServiceCallback} callback
   */
  destroyHiddenService(serviceId, callback) {
    this._send(commands.DEL_ONION(serviceId), callback);
  }
  /**
   * @callback TorController~destroyHiddenServiceCallback
   * @param {object|null} error
   */

  /**
   * Change the value for a configuration variable
   * @param {string} keyword - Configuration key
   * @param {string} value - New value to set
   * @param {TorController~setConfigCallback} callback
   */
  setConfig(keyword, value, callback) {
    this._send(commands.SETCONF(keyword, value), callback);
  }
  /**
   * @callback TorController~setConfigCallback
   * @param {object|null} error
   */

  /**
   * Change the value for a configuration variable to it's default
   * @param {string} keyword - Configuration key
   * @param {TorController~resetConfigCallback} callback
   */
  resetConfig(keyword, callback) {
    this._send(commands.RESETCONF(keyword), callback);
  }
  /**
   * @callback TorController~resetConfigCallback
   * @param {object|null} error
   */

  /**
   * Return the values for the given configuration key
   * @param {string} keyword - Configuration key
   * @param {TorController~getConfigCallback} callback
   */
  getConfig(keyword, callback) {
    this._send(commands.GETCONF(keyword), callback);
  }
  /**
   * @callback TorController~getConfigCallback
   * @param {object|null} error
   * @param {GetConfigResult} result
   */

  /**
   * Tell Tor to write out it's config value to it's torrc
   * @param {TorController~saveConfigCallback} callback
   */
  saveConfig(callback) {
    this._send(commands.SAVECONF(), callback);
  }
  /**
   * @callback TorController~saveConfigCallback
   * @param {object|null} error
   */

  /**
   * Reloads the config values set
   * @param {TorController~reloadConfigCallback} callback
   */
  reloadConfig(callback) {
    this.signal('RELOAD', callback);
  }
  /**
   * @callback TorController~reloadConfigCallback
   * @param {object|null} error
   */

  /**
   * Controlled shutdown signal
   * @param {TorController~shutdownCallback} callback
   */
  shutdown(callback) {
    this.signal('SHUTDOWN', callback);
  }
  /**
   * @callback TorController~shutdownCallback
   * @param {object|null} error
   */

  /**
   * Dump stats to tor log file
   * @param {TorController~dumpStatsCallback} callback
   */
  dumpStats(callback) {
    this.signal('DUMP', callback);
  }
  /**
   * @callback TorController~dumpStatsCallback
   * @param {object|null} error
   */

  /**
   * Set open logs to debug level
   * @param {TorController~enableDebugCallback} callback
   */
  enableDebug(callback) {
    this.signal('DEBUG', callback);
  }
  /**
   * @callback TorController~enableDebugCallback
   * @param {object|null} error
   */

  /**
   * Shutdown tor immediately
   * @param {TorController~haltCallback} callback
   */
  halt(callback) {
    this.signal('HALT', callback);
  }
  /**
   * @callback TorController~haltCallback
   * @param {object|null} error
   */

  /**
   * Forget client side hostname->ip cache
   * @param {TorController~clearDnsCacheCallback} callback
   */
  clearDnsCache(callback) {
    this.signal('CLEARDNSCACHE', callback);
  }
  /**
   * @callback TorController~clearDnsCacheCallback
   * @param {object|null} error
   */

  /**
   * Clears DNS cache and establishes new clean circuits
   * @param {TorController~cleanCircuitsCallback} callback
   */
  cleanCircuits(callback) {
    this.signal('NEWNYM', callback);
  }
  /**
   * @callback TorController~cleanCircuitsCallback
   * @param {object|null} error
   */

  /**
   * Dumps a heartbeat message to the logs
   * @param {TorController~dumpHeartbeatCallback} callback
   */
  dumpHeartbeat(callback) {
    this.signal('HEARTBEAT', callback);
  }
  /**
   * @callback TorController~dumpHeartbeatCallback
   * @param {object|null} error
   */

  /**
   * Sends a signal to the control port
   * @param {string} signal
   * @param {TorController~signalCallback} callback
   */
  signal(sig, callback) {
    this._send(commands.SIGNAL(sig), callback);
  }
  /**
   * @callback TorController~signalCallback
   * @param {object|null} error
   */

  /**
   * Instruct Tor to route requests to the target to the replacement
   * @param {string} target - Original address to map
   * @param {string} replacement - New address to route request to target
   * @param {TorController~createAddressMappingCallback} callback
   */
  createAddressMapping(target, replacement, callback) {
    this._send(commands.MAPADDRESS(target, replacement), callback);
  }
  /**
   * @callback TorController~createAddressMappingCallback
   * @param {object|null} error
   */

  /**
   * Creates a new circuit, returning the newly created circuit ID
   * @param {string} [purpose="general"] - The circuit purpose, either general|controller
   * @param {TorController~createCircuitCallback}
   */
  createCircuit(purpose, callback) {
    /* istanbul ignore if */
    if (typeof purpose === 'function') {
      callback = purpose;
      purpose = null;
    }

    this._send(commands.EXTENDCIRCUIT('0', purpose), callback);
  }
  /**
   * @callback TorController~createCircuitCallback
   * @param {object|null} error
   * @param {string[]} result
   */

  /**
   * Extends the existing circuit
   * @param {string} circuitId - The circuit ID to extend
   * @param {TorController~extendCircuitCallback}
   */
  extendCircuit(id, callback) {
    this._send(commands.EXTENDCIRCUIT(id), callback);
  }
  /**
   * @callback TorController~extendCircuitCallback
   * @param {object|null} error
   * @param {string[]} result
   */

  /**
   * Sets the purpose of the given circuit
   * @param {string} circuitId - The identifier for the circuit
   * @param {string} purpose - One of general|controller
   * @param {TorController~setCircuitPurposeCallback} callback
   */
  setCircuitPurpose(circuitId, purpose, callback) {
    this._send(commands.SETCIRCUITPURPOSE(circuitId, purpose), callback);
  }
  /**
   * @callback TorController~setCircuitPurposeCallback
   * @param {object|null} error
   */

  /**
   * Attaches the specified stream to the given circuit
   * @param {string} streamId - ID for the stream to attach
   * @param {string} [circuitId=0] - Circuit to attach stream
   * @param {number} [hopNumber] - Which hop to exit circuit
   * @param {TorController~attachStreamCallback} callback
   */
  attachStream(streamId, options, callback) {
    /* istanbul ignore if */
    if (typeof options === 'function') {
      callback = options;
      options = { circuitId: '0', hopNumber: null };
    }

    this._send(commands.ATTACHSTREAM(streamId, options), callback);
  }
  /**
   * @callback TorController~attachStreamCallback
   * @param {object|null} error
   */

  /**
   * Inform the server about a new descriptor
   * @param {object} descriptor - Key-value pairs for server descriptor
   * @param {object} [options]
   * @param {string} [options.purpose="general"] - general|controller|bridge
   * @param {boolean} [options.cache=true] - Flag for caching descriptor
   * @param {TorController~postDescriptorCallback} callback
   */
  postDescriptor(descriptor, options, callback) {
    /* istanbul ignore if */
    if (typeof options === 'function') {
      callback = options;
      options = {};
    }

    this._send(commands.POSTDESCRIPTOR(descriptor, options), callback);
  }
  /**
   * @callback TorController~postDescriptorCallback
   * @param {object|null} error
   */

  /**
   * Change the exit address on a given stream
   * @param {string} streamId - ID for stream to redirect
   * @param {string} address - Exit address for the given stream
   * @param {number} [port] - Exit port for the given stream
   * @param {TorController~redirectStreamCallback} callback
   */
  redirectStream(streamId, address, port, callback) {
    /* istanbul ignore if */
    if (typeof port === 'function') {
      callback = port;
      port = null;
    }

    this._send(commands.REDIRECTSTREAM(streamId, address, port), callback);
  }
  /**
   * @callback TorController~redirectStreamCallback
   * @param {object|null} error
   */

  /**
   * Closes the exit for the given stream
   * @param {string} streamId - ID for the stream to close
   * @param {number} [reason=1] - Reason code for closing stream
   * @param {TorController~closeStreamCallback} callback
   * @see https://gitweb.torproject.org/torspec.git/tree/tor-spec.txt#n1404
   */
  closeStream(streamId, reason, callback) {
    /* istanbul ignore if */
    if (typeof reason === 'function') {
      callback = reason;
      reason = 1;
    }

    this._send(commands.CLOSESTREAM(streamId, reason), callback);
  }
  /**
   * @callback TorController~closeStreamCallback
   * @param {object|null} error
   */

  /**
   * Closes the given circuit
   * @param {string} circuitId - ID for the circuit to close
   * @param {object} [options]
   * @param {boolean} [options.ifUnused=false] - Only close if not in use
   * @param {TorController~closeCircuitCallback} callback
   */
  closeCicuit(circuitId, options, callback) {
    /* istanbul ignore if */
    if (typeof options === 'function') {
      callback = options;
      options = { ifUnused: false };
    }

    this._send(commands.CLOSECIRCUIT(circuitId, options), callback);
  }
  /**
   * @callback TorController~closeCircuitCallback
   * @param {object|null} error
   */

  /**
   * Tells Tor to hang up on the controller
   * @param {TorController~quitCallback} callback
   */
  quit(callback) {
    this._send(commands.QUIT(), callback);
  }
  /**
   * @callback TorController~quitCallback
   * @param {object|null} error
   */

  /**
   * Launch remote hostname lookup - answer returnd as async ADDRMAP event
   * @param {string} address - Address to lookup
   * @param {object} [options]
   * @param {boolean} [options.reverse=false] - Perform reverse lookup
   * @param {TorController~resolveCallback} callback
   */
  resolve(address, options, callback) {
    /* istanbul ignore if */
    if (typeof options === 'function') {
      callback = options;
      options = {};
    }

    this._send(commands.RESOLVE(address, options.reverse), callback);
  }
  /**
   * @callback TorController~resolveCallback
   * @param {object|null} error
   */

  /**
   * Instruct Tor to load the configuration file from the given text
   * @param {string} configText - Complete torrc config text to load
   * @param {TorController~loadConfigCallback} callback
   */
  loadConfig(configText, callback) {
    this._send(commands.LOADCONF(configText), callback);
  }
  /**
   * @callback TorController~loadConfigCallback
   * @param {object|null} error
   */

  /**
   * Take ownership of the tor process - will close tor when the connection
   * closes
   * @param {TorController~takeOwnershipCallback} callback
   */
  takeOwnership(callback) {
    this._send(commands.TAKEOWNERSHIP(), (err) => {
      /* istanbul ignore if */
      if (err) {
        return callback(err);
      }

      this.resetConfig('__OwningControllerProcess', callback);
    });
  }
  /**
   * @callback TorController~takeOwnershipCallback
   * @param {object|null} error
   */

  /**
   * Tells the server to drop all guard nodes. Do not invoke this command
   * lightly; it can increase vulnerability to tracking attacks over time.
   * @param {TorController~dropGuardsCallback} callback
   */
  dropGuards(callback) {
    this._send(commands.DROPGUARDS(), callback);
  }
  /**
   * @callback TorController~dropGuardsCallback
   * @param {object|null} error
   */

  /**
   * Fetches descriptors for the given hidden service
   * @param {string} serviceId - ID for the hidden service
   * @param {string} [serverLongName] - Long name for specific server to use
   * @param {TorController~fetchHiddenServiceDescriptorCallback} callback
   */
  fetchHiddenServiceDescriptor(serviceId, serverLongName, callback) {
    /* istanbul ignore if */
    if (typeof serverLongName === 'function') {
      callback = serverLongName;
      serverLongName = '';
    }

    this._send(commands.HSFETCH(serviceId, serverLongName), callback);
  }
  /**
   * @callback TorController~fetchHiddenServiceDescriptorCallback
   * @param {object|null} error
   */

  /**
   * Launch a hidden service descriptor upload
   * @param {string} descriptor
   * @param {string} [serverLongName] - Long name for specific server to use
   * @param {TorController~postHiddenServiceDescriptorCallback} callback
   * @see https://gitweb.torproject.org/torspec.git/tree/rend-spec.txt#n193
   */
  postHiddenServiceDescriptor(descriptor, serverLongName, callback) {
    /* istanbul ignore if */
    if (typeof serverLongName === 'function') {
      callback = serverLongName;
      serverLongName = '';
    }

    this._send(commands.HSPOST(descriptor, serverLongName), callback);
  }
  /**
   * @callback TorController~postHiddenServiceDescriptorCallback
   * @param {object|null} error
   */

  /**
   * Get information from Tor not stored in configuration
   * @param {string} keyword - Keyword for info to fetch
   * @param {TorController~getInfoCallback} callback
   * @see https://gitweb.torproject.org/torspec.git/tree/control-spec.txt#n500
   */
  getInfo(keyword, callback) {
    this._send(commands.GETINFO(keyword), callback);
  }
  /**
   * @callback TorController~getInfoCallback
   * @param {object|null} error
   * @param {string} result
   */

  /**
   * Instructs Tor to send asynchronous events for the given types - these
   * events will be emitted from the controller. Calling this method resets
   * previously set event listeners
   * @param {string[]} events - List of event types to listen for
   * @param {TorController~addEventListenersCallback} callback
   * @see https://gitweb.torproject.org/torspec.git/tree/control-spec.txt#n1708
   */
  addEventListeners(events, callback) {
    this._send(commands.SETEVENTS(events), callback);
  }
  /**
   * @callback TorController~addEventListenersCallback
   * @param {object|null} error
   */

  /**
   * Instructs Tor to stop listening for events
   * @param {TorController~removeEventListenersCallback} callback
   */
  removeEventListeners(callback) {
    this._send(commands.SETEVENTS([]), callback);
  }
  /**
   * @callback TorController~removeEventListenersCallback
   * @param {object|null} error
   */

}

module.exports = TorController;
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-modules"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-granax.html">granax</a></div><div class="sidebar-section-children"><a href="module-granax_commands.html">granax/commands</a></div><div class="sidebar-section-children"><a href="module-granax_replies.html">granax/replies</a></div><div class="sidebar-section-children"><a href="module-granax_torrc.html">granax/torrc</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="TorController.html">TorController</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-events"><div>Events</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="TorController.html#event:close">close</a></div><div class="sidebar-section-children"><a href="TorController.html#event:error">error</a></div><div class="sidebar-section-children"><a href="TorController.html#event:ready">ready</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>